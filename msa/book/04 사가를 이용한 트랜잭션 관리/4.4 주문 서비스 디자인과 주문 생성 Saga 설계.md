# 4.4.0 전체 구조 소개

이제 앞서 배웠던 Saga 패턴을 Order 생성 서비스에 적용해 보자.

<img src="../../images/image-20211007001503053 2.png" alt="image" style="zoom:67%;" />

위 그림은 다음과 같은 클래스들로 이루어진다.

- **OrderService나 OrderEntity와 같은 일반적인 클래스**

- **Order Saga를 담당하는 여러 Saga 클래스**

  Saga Orchestrator인 OrderService는 여러가지 Saga들을 가질 수 있다

- **OrderService를 호출해서 command message들을 관리하는 OrderCommandHandlers Adapter 클래스**

  OrderService 또한 Saga의 참여자 중 하나이기 때문에 Saga에서 OrderService에게 보낸 Command 메세지를 관리하는 클래스가 필요하다.

## 4.4.1 OrderService 클래스

OrderService는 주문의 생성과 관리를 담당하는 도메인 서비스이다.

다음과 같은 관계를 가지게 된다.

![img](../../images/180.jpeg)

1. OrderRepository를 호출해서 Order를 저장/수정한다.

2. SagaManager로 CreateOrderSaga와 같은 Saga들을 생성한다.

   > 여기서 SagaManager는 Eventuate Tram Saga Framework에서 기본으로 제공되는 클래스로, Saga Orchestrator나 Saga Participant를 정의할 때 사용된다.

<br>

우선 OrderService의 `createOrder()` 메소드에 집중하자

```java
@RequiredArgsConstructor
@Transactional
public class OrderService {

	private final SagaManager<CreateOrderSagaState> createOrderSagaManager;

	private final OrderRepository orderRepository;

	private final DomainEventPublisher eventPublisher;

	public Order createOrder(OrderDetails orderDetails) {
    	ResultWithEvents<Order> orderAndEvents = Order.createOrder(…);
    	Order order = orderAndEvents.result;
	    OrderRepository.save(order);
        
        eventPublisher.publish(Order.class, Long.toString(order.getId()), orderAndEvents.events);
        CreateOrderSagaState state = new CreateOrderSagaState(order.getId(), orderDetails);
        CreateOrderSagaManager.create(state, Order.class, order.getId());
        return order;
    }
}
```

1. Order에 대한 정보가 담긴 OrderDetails를 파라미터로 받는다.

2. Order를 생성한다.

3. OrderRepository로 Order를 저장한다.

4. 새로 저장된 Order의 Id와 orderDetails에 대한 정보가 담긴 CreateOrderSagaState를 생성한다.

5. `CreateOrderSagaManager.create()`를 호출해서 Saga 인스턴스를 생성한다.

6. 첫 번째 Saga 참여자에게 Command 메세지가 전달된다.

7. Saga Orchestrator를 DB에 저장한다.

   

<br>

CreateOrderSaga의 전체적인 구조는 다음과 같다.

![img](../../images/182.jpeg)

